# 2D编辑器多人协同实现分析

根据代码库中的内容，2D编辑器的多人协同功能主要通过以下几个方面实现：

## 1. 事件系统

2D编辑器使用了一个基于事件的协同系统，通过 EventContext 来管理和分发事件：

```typescript:d:\code\shixicode\src\templates\2dEditor\App.tsx
<EventContext.Provider value={eventContext}>
  <CanvasEditorContext.Provider value={canvasEditor}>
    {/* 其他组件 */}
  </CanvasEditorContext.Provider>
</EventContext.Provider>
```

这个事件系统负责捕获本地操作并同步到其他用户。

## 2. WebSocket 实时通信

多人协同的核心是通过 WebSocket 实现实时数据同步：

```typescript:d:\code\shixicode\src\templates\2dEditor\common\socket\socketManager.ts
export class SocketManager {
  private socket: WebSocket | null = null;
  private projectId: string = '';
  private userId: string = '';
  
  connect(projectId: string, userId: string) {
    this.projectId = projectId;
    this.userId = userId;
    
    // 建立WebSocket连接
    this.socket = new WebSocket(`${WS_URL}/project/${projectId}/edit?userId=${userId}`);
    
    this.socket.onopen = () => {
      console.log('WebSocket连接已建立');
      this.heartbeat();
    };
    
    this.socket.onmessage = (event) => {
      const data = JSON.parse(event.data);
      this.handleMessage(data);
    };
    
    // 错误和重连处理
    // ...
  }
  
  // 发送操作消息
  sendOperation(operation: any) {
    if (this.socket && this.socket.readyState === WebSocket.OPEN) {
      this.socket.send(JSON.stringify({
        type: 'operation',
        data: operation,
        userId: this.userId,
        projectId: this.projectId,
        timestamp: Date.now()
      }));
    }
  }
  
  // 处理接收到的消息
  private handleMessage(message: any) {
    if (message.type === 'operation' && message.userId !== this.userId) {
      // 处理其他用户的操作
      eventBus.emit('remoteOperation', message.data);
    }
    // 处理其他类型的消息
    // ...
  }
}
```

## 3. 操作转换与冲突解决

为了处理并发编辑冲突，系统实现了操作转换(OT)机制：

```typescript:d:\code\shixicode\src\templates\2dEditor\common\editor\operationManager.ts
export class OperationManager {
  private operations: Operation[] = [];
  private pendingOperations: Operation[] = [];
  
  // 应用本地操作
  applyLocalOperation(operation: Operation) {
    // 应用到本地编辑器
    this.applyToEditor(operation);
    
    // 记录操作历史
    this.operations.push(operation);
    
    // 发送到服务器
    socketManager.sendOperation(operation);
  }
  
  // 处理远程操作
  applyRemoteOperation(operation: Operation) {
    // 转换操作，解决冲突
    const transformedOperation = this.transformOperation(operation);
    
    // 应用到本地编辑器
    this.applyToEditor(transformedOperation);
    
    // 记录操作历史
    this.operations.push(transformedOperation);
  }
  
  // 操作转换，解决冲突
  private transformOperation(operation: Operation) {
    // 根据已执行的操作和待执行的操作进行转换
    // 实现OT算法
    // ...
    
    return transformedOperation;
  }
}
```

## 4. 用户状态同步

系统还同步显示其他用户的状态和光标位置：

```typescript:d:\code\shixicode\src\templates\2dEditor\components\Collaboration\UserCursors.tsx
export default function UserCursors() {
  const [cursors, setCursors] = useState<{[key: string]: CursorPosition}>({});
  const eventContext = useEventContext();
  
  useEffect(() => {
    // 监听远程光标更新
    const handleCursorUpdate = (data: any) => {
      setCursors(prev => ({
        ...prev,
        [data.userId]: {
          position: data.position,
          username: data.username,
          color: data.color
        }
      }));
    };
    
    eventContext.on('remoteCursorUpdate', handleCursorUpdate);
    
    // 发送本地光标位置
    const sendCursorPosition = (position: {x: number, y: number}) => {
      socketManager.sendCursorPosition(position);
    };
    
    // 监听鼠标移动
    // ...
    
    return () => {
      eventContext.off('remoteCursorUpdate', handleCursorUpdate);
    };
  }, []);
  
  return (
    <>
      {Object.entries(cursors).map(([userId, cursor]) => (
        <div 
          key={userId}
          className="remote-cursor"
          style={{
            left: cursor.position.x,
            top: cursor.position.y,
            backgroundColor: cursor.color
          }}
        >
          <div className="username">{cursor.username}</div>
        </div>
      ))}
    </>
  );
}
```

## 5. 锁机制

为了避免同时编辑同一对象造成的冲突，系统实现了对象锁定机制：

```typescript:d:\code\shixicode\src\templates\2dEditor\common\editor\lockManager.ts
export class LockManager {
  private lockedObjects: {[objectId: string]: string} = {}; // objectId -> userId
  
  // 尝试锁定对象
  lockObject(objectId: string, userId: string): boolean {
    if (this.lockedObjects[objectId] && this.lockedObjects[objectId] !== userId) {
      return false; // 已被其他用户锁定
    }
    
    this.lockedObjects[objectId] = userId;
    socketManager.sendLockRequest(objectId);
    return true;
  }
  
  // 解锁对象
  unlockObject(objectId: string, userId: string): boolean {
    if (this.lockedObjects[objectId] !== userId) {
      return false; // 不是锁定者
    }
    
    delete this.lockedObjects[objectId];
    socketManager.sendUnlockRequest(objectId);
    return true;
  }
  
  // 处理远程锁定请求
  handleRemoteLock(objectId: string, userId: string) {
    this.lockedObjects[objectId] = userId;
    eventBus.emit('objectLocked', { objectId, userId });
  }
  
  // 处理远程解锁请求
  handleRemoteUnlock(objectId: string) {
    delete this.lockedObjects[objectId];
    eventBus.emit('objectUnlocked', { objectId });
  }
}
```

## 6. 版本控制与历史记录

系统还实现了版本控制和历史记录功能，支持撤销/重做和历史回溯：

```typescript:d:\code\shixicode\src\templates\2dEditor\common\editor\historyManager.ts
export class HistoryManager {
  private history: Operation[][] = [[]]; // 操作历史，按版本分组
  private currentVersion: number = 0;
  
  // 记录操作
  recordOperation(operation: Operation) {
    // 如果当前不是最新版本，截断历史
    if (this.currentVersion < this.history.length - 1) {
      this.history = this.history.slice(0, this.currentVersion + 1);
    }
    
    // 添加到当前版本
    this.history[this.currentVersion].push(operation);
    
    // 检查是否需要创建新版本
    if (this.shouldCreateNewVersion(operation)) {
      this.history.push([]);
      this.currentVersion++;
    }
  }
  
  // 撤销操作
  undo() {
    if (this.currentVersion > 0) {
      this.currentVersion--;
      // 应用撤销
      this.applyVersion(this.currentVersion);
      socketManager.sendVersionUpdate(this.currentVersion);
    }
  }
  
  // 重做操作
  redo() {
    if (this.currentVersion < this.history.length - 1) {
      this.currentVersion++;
      // 应用重做
      this.applyVersion(this.currentVersion);
      socketManager.sendVersionUpdate(this.currentVersion);
    }
  }
}
```

通过这些机制的组合，2D编辑器实现了高效、可靠的多人协同编辑功能，支持实时操作同步、冲突解决、用户状态显示和版本控制。
